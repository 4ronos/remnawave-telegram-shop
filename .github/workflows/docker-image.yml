name: Build docker image

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  # –û–±—â–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      labels: ${{ steps.meta.outputs.labels }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should_push: ${{ steps.should-push.outputs.should_push }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Should push images
        id: should-push
        run: |
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            echo "should_push=true" >> $GITHUB_OUTPUT
          else
            echo "should_push=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/remnawave-telegram-shop-bot
          tags: |
            # Always include latest tag for tags and main branch
            type=raw,value=latest,enable=${{ github.ref_type == 'tag' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}
            # Use semver tags when Git tag is in semver format
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # Use the short SHA for all builds
            type=sha,format=short,prefix=
            # Include the tag name if it's a tag-triggered build
            type=ref,event=tag
            # Include branch name for non-main branches
            type=ref,event=branch

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="${{ github.sha }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create build matrix
        id: set-matrix
        run: |
          echo "matrix={\"platform\":[\"linux/amd64\",\"linux/arm64\"]}" >> $GITHUB_OUTPUT

  # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
  build-per-arch:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –¥—Ä–∞–π–≤–µ—Ä–æ–º
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.12.5
            network=host

      # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GitHub Container Registry
      - name: Login to GitHub Container Registry
        if: needs.prepare.outputs.should_push == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # –ò–∑–≤–ª–µ–∫–∞–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (linux/amd64 -> amd64)
      - name: Extract architecture
        id: extract-arch
        run: |
          ARCH=$(echo ${{ matrix.platform }} | cut -d/ -f2)
          echo "arch=$ARCH" >> $GITHUB_OUTPUT
          echo "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $ARCH"

      # –°–æ–∑–¥–∞–µ–º —Ç–µ–≥–∏ —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (latest -> latest-amd64)
      - name: Create arch-specific tags
        id: meta-arch
        run: |
          ARCH=${{ steps.extract-arch.outputs.arch }}
          TAGS="${{ needs.prepare.outputs.tags }}"
          
          # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —Ç–µ–≥–∏ —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
          ARCH_TAGS=""
          while IFS= read -r TAG; do
            if [ -n "$TAG" ]; then
              ARCH_TAG="${TAG}-${ARCH}"
              ARCH_TAGS="${ARCH_TAGS}${ARCH_TAG}\n"
            fi
          done <<< "$TAGS"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ARCH_TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–µ—à–∞ –¥–ª—è Go –º–æ–¥—É–ª–µ–π —á–µ—Ä–µ–∑ actions/cache
      - name: Set up Go modules cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–µ—à–∞
      - name: Build and push per architecture
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: ${{ needs.prepare.outputs.should_push }}
          tags: ${{ steps.meta-arch.outputs.tags }}
          labels: ${{ needs.prepare.outputs.labels }}
          # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º GHA –∫–µ—à –¥–ª—è BuildX
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
          # –û—Ç–∫–ª—é—á–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é provenance –∏ sbom
          provenance: false
          sbom: false
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à Docker
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/cache:${{ steps.extract-arch.outputs.arch }}
          cache-to: ${{ needs.prepare.outputs.should_push == 'true' && format('type=registry,ref=ghcr.io/{0}/cache:{1},mode=max', github.repository_owner, steps.extract-arch.outputs.arch) || '' }}

  # –°–æ–∑–¥–∞–Ω–∏–µ –º—É–ª—å—Ç–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ–≥–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
  create-manifest:
    needs: [prepare, build-per-arch]
    if: needs.prepare.outputs.should_push == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.12.5
            network=host

      # –°–æ–∑–¥–∞–µ–º –º—É–ª—å—Ç–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤—Ä—É—á–Ω—É—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ–≥–∞
      - name: Create manifests
        run: |
          TAGS="${{ needs.prepare.outputs.tags }}"
          
          while IFS= read -r TAG; do
            if [ -n "$TAG" ]; then
              echo "Creating manifest for $TAG..."
              # –°–æ–∑–¥–∞–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç –∏ –≤–∫–ª—é—á–∞–µ–º –≤ –Ω–µ–≥–æ –æ–±—Ä–∞–∑—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä
              docker buildx imagetools create -t $TAG \
                $TAG-amd64 \
                $TAG-arm64 || echo "Warning: Failed to create manifest for $TAG"
            fi
          done <<< "$TAGS"

  # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
  send-notification:
    needs: [prepare, create-manifest]
    if: needs.prepare.outputs.should_push == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set commit message
        id: commit-message
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            # For tag events
            TAG_MSG=$(git tag -l --format='%(contents)' ${{ github.ref_name }})
            if [ -z "$TAG_MSG" ]; then
              TAG_MSG="Release ${{ github.ref_name }}"
            fi
          else
            # For workflow_dispatch or other events
            TAG_MSG="${{ github.event.head_commit.message || format('Manual build from {0}', github.ref_name) }}"
          fi
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
            üõ†Ô∏è ${{ github.ref_name }}
            üìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${{ steps.commit-message.outputs.message }}
            üîó –û–±—Ä–∞–∑—ã: 
               - –ú—É–ª—å—Ç–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π: ghcr.io/${{ github.repository_owner }}/remnawave-telegram-shop-bot:${{ github.ref_name }}
               - amd64: ghcr.io/${{ github.repository_owner }}/remnawave-telegram-shop-bot:${{ github.ref_name }}-amd64
               - arm64: ghcr.io/${{ github.repository_owner }}/remnawave-telegram-shop-bot:${{ github.ref_name }}-arm64
            üèóÔ∏è –°–æ–±—Ä–∞–Ω–æ: ${{ github.workflow }} #${{ github.run_number }}
            ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${{ github.run_attempt }}
